Amos Waterland
27 OCT 2003

REQUIREMENTS

You need to have your network set up so that TEST (the machine on which you
are going to run this testcase) can do an ethernet broadcast to SERVER (the
machine which is going to run pppoe-server).

The reason for this requirement is the PPPoE protocol itself, which describes
its discovery phase thusly:

 To initiate discovery, the PPPoE client sends a PPPoE Active Discovery
 Initiation (PADI) frame.  This frame is sent to the broadcast Ethernet
 address (FF:FF:FF:FF:FF:FF) ...

Note that some routers (namely, the Cisco 2940) seem to snarf PADI frames.
The most fool-proof method is to just use a dumb hub, where both TEST and
server are plugged into the hub.

If you are disconnecting SERVER and TEST from other networks for this test
run, you should reconfigure their routing for the duration of the test.  Log
into SERVER and run:

 ifconfig eth0 192.168.1.1

Then log into TEST and run:

 ifconfig eth0 192.168.1.2

SETUP SERVER

Once you have your network setup as described above, you need to configure
SERVER so that it is running pppoe-server.

If SERVER is a Redhat 9 box, setup is usually quite easy.  Just run the
following command as root:

 # printf "\n\n\n\n\n\n\n\n0\n\ny\n" | adsl-setup

If SERVER is a SuSE box, setup can be more complicated.  Run this command:

 # adsl-setup

and answer its questions.  Use `root' as the username, just hit <enter>
when prompted for a password, and select the no-firewall option.  Then make
sure that /etc/ppp/pap-secrets has this entry:

 "root" * "" *

and /etc/pp/pppoe-server-options has the 'login' option commented out.

Finally, start the pppoe-server as follows:

  # pppoe-server -F

RUN TEST

Once the pppoe-server is running on SERVER, log into TEST and run ./ppp.sh.

TROUBLESHOOTING

If adsl-start prints a row of '.' characters and fails with a timeout message,
read the log files on both the client (TEST) and the server (SERVER).  If
/var/log/messages on SERVER has this message:

 remote host not authorized for address x.x.x.x

you need to make sure that there are four entries (instead of three) in
/etc/ppp/pap-secrets on SERVER, reading something like:

 "root" * "" *

If adsl-start prints a row of '.' characters and fails with a timeout message,
read the log files on both the client (TEST) and the server (SERVER).  If
/var/log/messages on SERVER has this message:

 PAP login failure for root

you need to modify /etc/pp/pppoe-server-options to disable the 'login' option.
The login option tells ppp to read from /etc/passwd, which is undesireable for
an automated testcase.  You can just comment it out.

If the testcase says that discovery failed, see the REQUIREMENTS section
above.  Make sure that you have TEST and SERVER connected to a network where
they can ethernet broadcast to each other.  Note that some Cisco routers seem
to have a problem with PADI frames.

The testcase assumes that adsl-setup will pick the right ethernet interface.
If it picks eth1 when you want it to pick eth0, you need to modify the set of
answers that printf is piping into adsl-setup (FIXME: this really should be a
variable).

NOTES

It would be really nice if this test could be run over a loopback/alias.  I
tried and tried to get this to work, but could not.  In case somebody wants to
try some more, the basic approach is to do all the permutations of the
following:

ifconfig eth0:0 inet 10.13.0.1
pppoe-relay -B eth0 -B eth0:0
pppoe-server -F -k -I eth0:0
ifup ppp0
